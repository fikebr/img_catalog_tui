{% extends "base.html" %}

{% block title %}Image Catalog Review - {{ foldername }}{% endblock %}

{% block page_title %}Image Catalog Review: {{ foldername }}{% endblock %}


{% block head %}
<!-- Review page styles are now in main.css -->
{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav class="breadcrumb-nav">
    <div class="breadcrumb-items">
        <a href="/">Home</a>
        <span class="breadcrumb-separator">→</span>
        <a href="/folders">Folders</a>
        <span class="breadcrumb-separator">→</span>
        <a href="/folder/{{ foldername }}">{{ foldername }}</a>
        <span class="breadcrumb-separator">→</span>
        <a href="/review/{{ foldername }}/list">Reviews</a>
        <span class="breadcrumb-separator">→</span>
        <span class="breadcrumb-current">{{ name }}</span>
    </div>
</nav>

<nav class="review-nav">
    <h3 style="margin: 0 0 var(--space-md) 0; color: var(--accent);">Navigation</h3>
    <div style="font-size: 0.875rem; color: var(--text);">
        <p>Total: <span id="totalCount">0</span></p>
        <p>Visible: <span id="visibleCount">0</span></p>
        <p>Status: <span id="loadingStatus">Loading...</span></p>
    </div>
    
    <div style="margin-top: var(--space-lg); padding-top: var(--space-md); border-top: 1px solid var(--border);">
        <h4 style="margin: 0 0 var(--space-sm) 0; color: var(--accent); font-size: 0.875rem;">Keyboard Shortcuts</h4>
        <div style="font-size: 0.75rem; color: var(--text); line-height: 1.4;">
            <p style="margin: var(--space-xs) 0;">← → Navigate</p>
            <p style="margin: var(--space-xs) 0;">1-5 Actions</p>
            <p style="margin: var(--space-xs) 0;">h/? Help</p>
        </div>
    </div>
</nav>

<section class="review-content">
    {% if error %}
    <div class="error">
        {{ error }}
    </div>
    {% elif not imagesets %}
    <div class="loading">No imagesets found for review.</div>
    {% else %}
    <div class="review-cards" id="cards" style="width:100%">
        {% for imageset_name, imageset_data in imagesets.items() %}
        <article class="review-card" data-imagesetname="{{ imageset_name }}" data-folder="{{ imageset_data.imageset_folder or '' }}">
            <div class="review-card-header">
                <span class="title">{{ imageset_name }}</span>
            </div>
            <div class="review-card-content">
              {% set cover_image = imageset_data.cover_image.split('\\')[-1].split('/')[-1] if imageset_data.cover_image else none %}
              {% if not cover_image and imageset_data.files %}
                {% set orig_files = [] %}
                {% for filename, file_info in imageset_data.files.items() %}
                  {% if '_orig' in filename %}
                    {% set _ = orig_files.append(filename) %}
                  {% endif %}
                {% endfor %}
                {% if orig_files %}
                  {% set cover_image = orig_files[0] %}
                {% else %}
                  {% set cover_image = imageset_data.files.keys() | list | first %}
                {% endif %}
              {% endif %}
              
              {% if cover_image %}
              <img src="/images/{{ foldername }}/{{ imageset_name }}/{{ cover_image }}" 
                   alt="{{ imageset_name }}" 
                   class="card-image" 
                   onclick="openImage('{{ imageset_name }}', '{{ cover_image }}', '{{ foldername }}')"
                   onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
              <p style="display:none;">Image not found: {{ cover_image }}</p>
              {% else %}
              <p>No cover image found</p>
              {% endif %}
              
              <div class="card-meta">
                
                <!-- Status & Files Section -->
                <div class="meta-section">
                  <h4 class="meta-section-title">Details</h4>
                  <div class="meta-row">
                    <span class="meta-label">Status:</span>
                    <span class="status {{ imageset_data.status or 'new' }}">{{ imageset_data.status or 'new' }}</span>
                  </div>
                  <div class="meta-row">
                    <span class="meta-label">Files:</span>
                    <span class="meta-value">{{ (imageset_data.files | length) if imageset_data.files else 0 }}</span>
                  </div>
                </div>

                <!-- Content Information -->
                {% if imageset_data.prompt or imageset_data.source %}
                <div class="meta-section">
                  <h4 class="meta-section-title">Content</h4>
                  {% if imageset_data.prompt %}
                  <div class="meta-row">
                    <span class="meta-label">Prompt:</span>
                    <span class="meta-value">{{ imageset_data.prompt }}</span>
                  </div>
                  {% endif %}
                  {% if imageset_data.source %}
                  <div class="meta-row">
                    <span class="meta-label">Source:</span>
                    <span class="meta-value">{{ imageset_data.source }}</span>
                  </div>
                  {% endif %}
                </div>
                {% endif %}

                <!-- Workflow Information -->
                {% if imageset_data.edits or imageset_data.needs or imageset_data.good_for %}
                <div class="meta-section">
                  <h4 class="meta-section-title">Workflow</h4>
                  {% if imageset_data.edits %}
                  <div class="meta-row">
                    <span class="meta-label">Edits:</span>
                    <span class="meta-value">{{ imageset_data.edits }}</span>
                  </div>
                  {% endif %}
                  {% if imageset_data.needs %}
                  <div class="meta-row">
                    <span class="meta-label">Needs:</span>
                    <span class="meta-value">{{ imageset_data.needs }}</span>
                  </div>
                  {% endif %}
                  {% if imageset_data.good_for %}
                  <div class="meta-row">
                    <span class="meta-label">Good for:</span>
                    <span class="meta-value">{{ imageset_data.good_for }}</span>
                  </div>
                  {% endif %}
                </div>
                {% endif %}

                <!-- Publishing Information -->
                {% if imageset_data.posted_to %}
                <div class="meta-section">
                  <h4 class="meta-section-title">Publishing</h4>
                  <div class="meta-row">
                    <span class="meta-label">Posted to:</span>
                    <span class="meta-value">{{ imageset_data.posted_to }}</span>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
            <div class="review-card-footer">
                <div>
                    {% for option in options %}
                    <button class="btn option-btn" data-option="{{ option }}">{{ option.title() }}</button>
                    {% endfor %}
                </div>
                <button class="btn copy-path" 
                    data-folder="{{ imageset_data.imageset_folder or '' }}" 
                    data-imageset="{{ imageset_name }}"
                    onclick="copyWindowsPath(this)">Copy Path</button>
                <button class="btn imageset-link" 
                    data-imageset="{{ imageset_name }}"
                    onclick="openImagesetPage(this)">Imageset</button>
            </div>
        </article>
        {% endfor %}
    </div>
    {% endif %}
</section>

<!-- Dynamic Carts based on options -->
<div class="carts" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: var(--space-md); align-items:start;">
    <div style="display:flex; justify-content:flex-end; margin-bottom: var(--space-md);">
        <button id="applyAllBtn" class="btn" style="padding: var(--space-xs) var(--space-sm); font-size: 0.85rem; background: var(--accent); color: white;">Apply All</button>
    </div>
    {% for option in options %}
    <aside class="cart" id="{{ option }}Cart">
        <div class="cart-header">
            <strong>{{ option.title() }}</strong>
            <span id="{{ option }}Count" style="color: var(--muted); font-weight: normal;">(0)</span>
            <div style="display: flex; gap: var(--space-xs);">
                <button id="copy{{ option.title() }}Btn" class="btn" style="padding: var(--space-xs) var(--space-sm); font-size: 0.75rem;">Copy</button>
                <button id="clear{{ option.title() }}Btn" class="btn" style="padding: var(--space-xs) var(--space-sm); font-size: 0.75rem;">Clear</button>
                <button id="apply{{ option.title() }}Btn" class="btn" style="padding: var(--space-xs) var(--space-sm); font-size: 0.75rem; background: var(--accent); color: white;">Apply</button>
            </div>
        </div>
        <div class="cart-items" id="{{ option }}Items" style="max-height: 260px; overflow: auto;"></div>
    </aside>
    {% endfor %}
</div>

<div class="toast" id="toast" hidden><div id="toastMsg">Copied!</div></div>
{% endblock content %}

{% block scripts %}
<script>
    console.log('Reviews.html JavaScript loading...');
    const $ = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>r.querySelectorAll(s);
    const cardsEl = $('#cards');
    const toastEl = $('#toast');
    const toastMsgEl = $('#toastMsg');
    const loadingEl = $('#loadingMessage');
    const errorEl = $('#errorMessage');
    const loadingStatusEl = $('#loadingStatus');

    // Initialize state object with dynamic options
    const reviewOptions = JSON.parse('{{ options | tojson | safe }}');
    const reviewType = '{{ review_type }}';
    const reviewAppend = JSON.parse('{{ review_obj.append | tojson | safe }}');
    const state = {};
    reviewOptions.forEach(option => {
        state[option] = [];
    });

    // Keyboard navigation state
    let currentImagesetIndex = 0;
    let visibleImagesets = [];

    function showToast(msg){toastMsgEl.textContent=msg;toastEl.hidden=false;clearTimeout(showToast.t);showToast.t=setTimeout(()=>toastEl.hidden=true,1200);}
    function getInitials(str){return str.slice(0,2).toUpperCase();}

    function buildCartItem(name,title,cart,imagePath){
      const item=document.createElement('div');
      item.className='cart-item';
      item.dataset.imagesetname=name;
      
      // Create thumbnail image or fallback to initials
      let thumbContent;
      if (imagePath) {
        const foldername = '{{ foldername }}';
        const imageSrc = `/images/${foldername}/${name}/${imagePath}`;
        thumbContent = `<img src="${imageSrc}" alt="${title||name}" class="thumb-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"><div class="thumb-fallback" style="display:none;">${getInitials(title||name)}</div>`;
      } else {
        thumbContent = `<div class="thumb-fallback">${getInitials(title||name)}</div>`;
      }
      
      item.innerHTML=`<div class="thumb">${thumbContent}</div><button class="remove-btn" onclick="removeFromCart('${name}', '${cart}')" title="Remove from cart">×</button>`;
      return item;
    }

    function addToCart(card,cart){
      const name=card.dataset.imagesetname;const title=card.querySelector('.title')?.textContent.trim();
      if(state[cart].includes(name))return;
      state[cart].push(name);
      card.hidden=true;
      
      // Extract image path from the card's image element
      const imageEl = card.querySelector('.card-image');
      const imagePath = imageEl ? imageEl.src.split('/').pop() : null;
      
      const item=buildCartItem(name,title,cart,imagePath);
      $("#"+cart+"Items").appendChild(item);
      updateCounts();
      updateCartCount(cart);
    }

    function removeFromCart(imagesetName, cart) {
      // Remove from state
      const index = state[cart].indexOf(imagesetName);
      if (index > -1) {
        state[cart].splice(index, 1);
      }
      
      // Remove from DOM
      const cartItems = $('#' + cart + 'Items');
      const itemToRemove = cartItems.querySelector(`[data-imagesetname="${CSS.escape(imagesetName)}"]`);
      if (itemToRemove) {
        itemToRemove.remove();
      }
      
      // Restore the original card to the review section
      const originalCard = cardsEl.querySelector(`.review-card[data-imagesetname="${CSS.escape(imagesetName)}"]`);
      if (originalCard) {
        originalCard.hidden = false;
      }
      
      updateCounts();
      updateCartCount(cart);
    }

    function copyList(cart){
      const text=state[cart].join('\n');
      if(!text){showToast('Empty '+cart);return;}
      navigator.clipboard.writeText(text).then(()=>showToast('Copied')).catch(()=>showToast('Fail'));
    }
    
    function clearCart(cart){
      state[cart].forEach(name=>{const orig=cardsEl.querySelector(`.review-card[data-imagesetname="${CSS.escape(name)}"]`);if(orig)orig.hidden=false;});
      state[cart]=[];$('#'+cart+'Items').innerHTML='';
      updateCounts();
      updateCartCount(cart);
    }

    async function applyCart(cart) {
      const imagesets = state[cart];
      if (!imagesets || imagesets.length === 0) {
        showToast('Empty ' + cart + ' cart');
        return;
      }

      try {
        // Get foldername from the page context
        const foldername = '{{ foldername }}';
        
        // Prepare the API payload
        const payload = {
          update_type: reviewType,
          value: cart,
          imagesets: imagesets,
          append: reviewAppend
        };

        // Make the API call
        const response = await fetch(`/api/folder/${foldername}/batch_update`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (response.ok) {
          // Success - clear the cart without restoring cards to review section
          // Only restore failed imagesets back to the review section
          if (result.failed_imagesets && result.failed_imagesets.length > 0) {
            result.failed_imagesets.forEach(name => {
              const orig = cardsEl.querySelector(`.review-card[data-imagesetname="${CSS.escape(name)}"]`);
              if (orig) orig.hidden = false;
            });
          }
          
          // Clear the cart state and DOM
          state[cart] = [];
          $('#' + cart + 'Items').innerHTML = '';
          updateCounts();
          updateCartCount(cart);
          
          const successMsg = result.failed_count > 0 
            ? `Applied ${result.successful_count}/${result.total_imagesets} (${result.failed_count} failed)`
            : `Applied ${result.successful_count} imagesets to ${cart}`;
          showToast(successMsg);
        } else {
          // Error response from API
          showToast(`Apply failed: ${result.error || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Apply cart error:', error);
        showToast('Apply failed: Network error');
      }
    }

    function updateCounts() {
      const total = $$('.review-card').length;
      const visible = $$('.review-card:not([hidden])').length;
      $('#totalCount').textContent = total;
      $('#visibleCount').textContent = visible;
      updateVisibleImagesets();
    }

    function updateCartCount(cart){
      const countSpan = $('#'+cart+'Count');
      if(countSpan){
        countSpan.textContent = '(' + (state[cart]?.length || 0) + ')';
      }
    }

    function updateVisibleImagesets() {
      visibleImagesets = Array.from($$('.review-card:not([hidden])'));
      console.log(`Updated visible imagesets: ${visibleImagesets.length} found`);
      // Ensure current index is within bounds
      if (currentImagesetIndex >= visibleImagesets.length) {
        currentImagesetIndex = Math.max(0, visibleImagesets.length - 1);
      }
      updateCurrentSelection();
    }

    function updateCurrentSelection() {
      // Remove previous selection highlight
      $$('.review-card').forEach(card => card.classList.remove('keyboard-selected'));
      
      console.log(`Updating selection: index ${currentImagesetIndex}, visible count: ${visibleImagesets.length}`);
      
      // Add highlight to current selection
      if (visibleImagesets.length > 0 && currentImagesetIndex >= 0 && currentImagesetIndex < visibleImagesets.length) {
        const currentCard = visibleImagesets[currentImagesetIndex];
        currentCard.classList.add('keyboard-selected');
        console.log('Added keyboard-selected class to card');
        
        // Scroll into view if needed
        currentCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } else {
        console.log('No valid selection to highlight');
      }
    }

    function navigateImagesets(direction) {
      console.log(`Navigate ${direction}, visible: ${visibleImagesets.length}, current: ${currentImagesetIndex}`);
      if (visibleImagesets.length === 0) {
        console.log('No visible imagesets to navigate');
        return;
      }
      
      const oldIndex = currentImagesetIndex;
      if (direction === 'left' && currentImagesetIndex > 0) {
        currentImagesetIndex--;
      } else if (direction === 'right' && currentImagesetIndex < visibleImagesets.length - 1) {
        currentImagesetIndex++;
      }
      
      console.log(`Index changed from ${oldIndex} to ${currentImagesetIndex}`);
      updateCurrentSelection();
    }

    function triggerActionButton(buttonIndex) {
      if (visibleImagesets.length === 0 || currentImagesetIndex < 0 || currentImagesetIndex >= visibleImagesets.length) {
        return;
      }
      
      const currentCard = visibleImagesets[currentImagesetIndex];
      const actionButtons = currentCard.querySelectorAll('.option-btn');
      
      if (buttonIndex >= 1 && buttonIndex <= actionButtons.length) {
        const button = actionButtons[buttonIndex - 1];
        button.click();
        showToast(`Applied: ${button.textContent}`);
      }
    }

    // Function to open image in new tab
    function openImage(imagesetName, imagePath, foldername) {
      if (!imagePath) return;
      
      // Construct the full path using the image serving route
      const fullPath = `/images/${foldername}/${imagesetName}/${imagePath}`;
      window.open(fullPath, '_blank');
    }
    
    // Helper function to join Windows paths properly
    function joinWinPath(dir, name) {
      let p = dir.replace(/\//g, '\\');
      if (!p.endsWith('\\')) p += '\\';
      return p + name;
    }
    
    // Function to copy a Windows path
    function copyWindowsPath(btn) {
      const folderPath = btn.dataset.folder;
      // Use the folder path directly since it already contains the full path to the imageset
      const path = folderPath.replace(/\//g, '\\');
      navigator.clipboard.writeText(path).then(() => {
        showToast('Copied path');
      }).catch(err => {
        console.error('Failed to copy: ', err);
        showToast('Copy failed');
      });
    }
    
    // Function to open imageset page in new tab
    function openImagesetPage(btn) {
      const imagesetName = btn.dataset.imageset;
      const foldername = '{{ foldername }}';
      const url = `/imageset/${foldername}/${imagesetName}`;
      window.open(url, '_blank');
    }

    // Event listeners
    $('.review-content').addEventListener('click',e=>{
      const card=e.target.closest('.review-card');
      if(!card)return;
      if(e.target.classList.contains('option-btn')){
        const option = e.target.dataset.option;
        addToCart(card, option);
      }
    });

    // Dynamic event listeners for copy, clear, and apply buttons
    reviewOptions.forEach(option => {
        const copyBtn = $('#copy' + option.charAt(0).toUpperCase() + option.slice(1) + 'Btn');
        const clearBtn = $('#clear' + option.charAt(0).toUpperCase() + option.slice(1) + 'Btn');
        const applyBtn = $('#apply' + option.charAt(0).toUpperCase() + option.slice(1) + 'Btn');
        
        if (copyBtn) copyBtn.onclick = () => copyList(option);
        if (clearBtn) clearBtn.onclick = () => clearCart(option);
        if (applyBtn) applyBtn.onclick = () => applyCart(option);
        updateCartCount(option);
    });

    // Apply all carts sequentially
    async function applyAllCarts() {
      for (const option of reviewOptions) {
        if (state[option] && state[option].length > 0) {
          await applyCart(option);
        }
      }
      showToast('All carts applied');
    }

    const applyAllBtn = $('#applyAllBtn');
    if (applyAllBtn) {
      applyAllBtn.onclick = () => applyAllCarts();
    }

    // Keyboard event handler
    console.log('Attaching keyboard event listener...');
    document.addEventListener('keydown', function(e) {
      console.log(`Key pressed: ${e.key}, target: ${e.target.tagName}`);
      
      // Only handle keyboard shortcuts when not typing in an input field
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        console.log('Ignoring key press - in input field');
        return;
      }
      
      switch(e.key) {
        case 'ArrowLeft':
          console.log('Left arrow pressed');
          e.preventDefault();
          navigateImagesets('left');
          break;
        case 'ArrowRight':
          console.log('Right arrow pressed');
          e.preventDefault();
          navigateImagesets('right');
          break;
        case '1':
        case '2':
        case '3':
        case '4':
        case '5':
          console.log(`Number ${e.key} pressed`);
          e.preventDefault();
          triggerActionButton(parseInt(e.key));
          break;
        case '?':
        case 'h':
          console.log('Help key pressed');
          e.preventDefault();
          showKeyboardHelp();
          break;
      }
    });

    function showKeyboardHelp() {
      const helpText = `Keyboard Shortcuts:
← → : Navigate between imagesets
1-5 : Apply action buttons (1=${reviewOptions[0] || 'N/A'}, 2=${reviewOptions[1] || 'N/A'}, etc.)
h/? : Show this help`;
      
      showToast(helpText);
    }

    // Test function - call from browser console: testKeyboard()
    window.testKeyboard = function() {
      console.log('=== KEYBOARD TEST ===');
      console.log('Visible imagesets:', visibleImagesets.length);
      console.log('Current index:', currentImagesetIndex);
      console.log('Review options:', reviewOptions);
      console.log('Cards element:', cardsEl);
      console.log('All review cards:', $$('.review-card').length);
      console.log('Visible review cards:', $$('.review-card:not([hidden])').length);
      
      if (visibleImagesets.length > 0) {
        console.log('Testing navigation...');
        navigateImagesets('right');
      } else {
        console.log('No visible imagesets to test with');
      }
    };

    // Initialize page when DOM loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing keyboard navigation...');
      
      // Update counts for already rendered cards
      updateCounts();
      $('#loadingStatus').textContent = 'Loaded';
      
      // Set initial selection to first visible imageset
      // updateCounts() already calls updateVisibleImagesets() which calls updateCurrentSelection()
      // So we just need to ensure we start at index 0
      currentImagesetIndex = 0;
      updateCurrentSelection();
      
      console.log('Keyboard navigation initialized. Try pressing arrow keys or type testKeyboard() in console.');
    });
</script>
{% endblock scripts %}
