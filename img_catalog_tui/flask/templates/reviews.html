{% extends "base.html" %}

{% block title %}Image Catalog Review - {{ foldername }}{% endblock %}

{% block page_title %}Image Catalog Review: {{ foldername }}{% endblock %}

{% block navigation %}
    <div style="font-size: 0.9rem; opacity: 0.8;">Review Type: {{ review_type }}</div>
{% endblock %}

{% block head %}
<style>
    /* Custom styles for review page layout */
    main { padding: var(--space-md); }
    
    .review-nav {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        padding: var(--space-sm);
        position: fixed;
        top: 72px;
        left: var(--space-md);
        width: 200px;
        height: calc(100% - 100px);
        overflow: auto;
        z-index: 40;
    }
    
    .review-content {
        margin-left: 240px;
        margin-right: 320px;
        max-width: calc(100% - 560px);
    }
    
    .review-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(700px, 1fr));
        gap: var(--space-xl);
        width: 100%;
    }
    
    .review-card {
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        overflow: hidden;
        background: rgba(255, 255, 255, 0.02);
        display: flex;
        flex-direction: column;
        min-height: 700px;
    }
    
    .review-card[hidden] { display: none !important; }
    
    .review-card-header {
        padding: var(--space-md) var(--space-lg);
        background: linear-gradient(90deg, rgba(96, 165, 250, 0.2), rgba(34, 211, 238, 0.2));
        border-bottom: 1px solid var(--border);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        font-size: 1.125rem;
    }
    
    .review-card-content {
        flex: 1;
        padding: var(--space-xl);
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        gap: var(--space-md);
    }
    
    .review-card-footer {
        padding: var(--space-lg);
        border-top: 1px solid var(--border);
        display: flex;
        gap: var(--space-md);
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .carts {
        position: fixed;
        top: 72px;
        right: var(--space-md);
        width: 280px;
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
        z-index: 40;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
    }
    
    .cart {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        padding: var(--space-sm);
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
        min-height: 150px;
        max-height: 300px;
        overflow: auto;
    }
    
    .cart-header {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        justify-content: space-between;
        font-weight: 600;
    }
    
    .cart-items {
        display: grid;
        gap: var(--space-sm);
    }
    
    .cart-item {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: var(--space-sm);
        align-items: center;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: var(--space-sm);
        background: rgba(255, 255, 255, 0.03);
    }
    
    .thumb {
        width: 44px;
        height: 44px;
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        display: grid;
        place-items: center;
        font-weight: 800;
        font-size: 0.75rem;
        background: var(--muted);
    }
    
    .toast {
        position: fixed;
        inset: auto 0 18px;
        display: grid;
        place-items: center;
        pointer-events: none;
        z-index: 100;
    }
    
    .toast > div {
        background: rgba(17, 24, 39, 0.9);
        border: 1px solid var(--border);
        padding: var(--space-sm) var(--space-md);
        border-radius: 999px;
        box-shadow: var(--shadow-lg);
    }
    
    /* Responsive adjustments */
    @media (max-width: 2000px) {
        .review-cards { grid-template-columns: repeat(auto-fit, minmax(600px, 1fr)); }
    }
    @media (max-width: 1600px) {
        .review-cards { grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); }
    }
    @media (max-width: 1200px) {
        .review-cards { grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); }
        .review-content { margin-left: 220px; margin-right: 300px; }
        .review-nav { width: 180px; }
        .carts { width: 260px; }
    }
</style>
{% endblock %}

{% block content %}
<nav class="review-nav">
    <h3 style="margin: 0 0 var(--space-md) 0; color: var(--accent);">Navigation</h3>
    <div style="font-size: 0.875rem; color: var(--text);">
        <p>Total: <span id="totalCount">0</span></p>
        <p>Visible: <span id="visibleCount">0</span></p>
        <p>Status: <span id="loadingStatus">Loading...</span></p>
    </div>
</nav>

<section class="review-content">
    {% if error %}
    <div class="error">
        {{ error }}
    </div>
    {% elif not imagesets %}
    <div class="loading">No imagesets found for review.</div>
    {% else %}
    <div class="review-cards" id="cards" style="width:100%">
        {% for imageset_name, imageset_data in imagesets.items() %}
        <article class="review-card" data-imagesetname="{{ imageset_name }}" data-folder="{{ imageset_data.imageset_folder or '' }}">
            <div class="review-card-header">
                <span class="title">{{ imageset_name }}</span>
            </div>
            <div class="review-card-content">
              {% set cover_image = imageset_data.cover_image.split('\\')[-1].split('/')[-1] if imageset_data.cover_image else none %}
              {% if not cover_image and imageset_data.files %}
                {% set orig_files = [] %}
                {% for filename, file_info in imageset_data.files.items() %}
                  {% if '_orig' in filename %}
                    {% set _ = orig_files.append(filename) %}
                  {% endif %}
                {% endfor %}
                {% if orig_files %}
                  {% set cover_image = orig_files[0] %}
                {% else %}
                  {% set cover_image = imageset_data.files.keys() | list | first %}
                {% endif %}
              {% endif %}
              
              {% if cover_image %}
              <img src="/images/{{ foldername }}/{{ imageset_name }}/{{ cover_image }}" 
                   alt="{{ imageset_name }}" 
                   class="card-image" 
                   onclick="openImage('{{ imageset_name }}', '{{ cover_image }}', '{{ foldername }}')"
                   onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
              <p style="display:none;">Image not found: {{ cover_image }}</p>
              {% else %}
              <p>No cover image found</p>
              {% endif %}
              
              <div class="card-meta">
                <h3>Details</h3>
                <p><strong>Status:</strong> <span class="status {{ imageset_data.status or 'new' }}">{{ imageset_data.status or 'new' }}</span></p>
                <p><strong>Files:</strong> {{ (imageset_data.files | length) if imageset_data.files else 0 }}</p>
                {% if imageset_data.prompt %}
                <p><strong>Prompt:</strong> {{ imageset_data.prompt }}</p>
                {% endif %}
                {% if imageset_data.source %}
                <p><strong>Source:</strong> {{ imageset_data.source }}</p>
                {% endif %}
                {% if imageset_data.edits %}
                <p><strong>Edits:</strong> {{ imageset_data.edits }}</p>
                {% endif %}
                {% if imageset_data.needs %}
                <p><strong>Needs:</strong> {{ imageset_data.needs }}</p>
                {% endif %}
              </div>
            </div>
            <div class="review-card-footer">
                <div>
                    {% for option in options %}
                    <button class="btn option-btn" data-option="{{ option }}">{{ option.title() }}</button>
                    {% endfor %}
                </div>
                <button class="btn copy-path" 
                    data-folder="{{ imageset_data.imageset_folder or '' }}" 
                    data-imageset="{{ imageset_name }}"
                    onclick="copyWindowsPath(this)">Copy Path</button>
            </div>
        </article>
        {% endfor %}
    </div>
    {% endif %}
</section>

<!-- Dynamic Carts based on options -->
<div class="carts">
    {% for option in options %}
    <aside class="cart" id="{{ option }}Cart">
        <div class="cart-header">
            <strong>{{ option.title() }}</strong>
            <div style="display: flex; gap: var(--space-xs);">
                <button id="copy{{ option.title() }}Btn" class="btn" style="padding: var(--space-xs) var(--space-sm); font-size: 0.75rem;">Copy</button>
                <button id="clear{{ option.title() }}Btn" class="btn" style="padding: var(--space-xs) var(--space-sm); font-size: 0.75rem;">Clear</button>
                <button id="apply{{ option.title() }}Btn" class="btn" style="padding: var(--space-xs) var(--space-sm); font-size: 0.75rem; background: var(--accent); color: white;">Apply</button>
            </div>
        </div>
        <div class="cart-items" id="{{ option }}Items"></div>
    </aside>
    {% endfor %}
</div>

<div class="toast" id="toast" hidden><div id="toastMsg">Copied!</div></div>
{% endblock content %}

{% block scripts %}
<script>
    const $ = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>r.querySelectorAll(s);
    const cardsEl = $('#cards');
    const toastEl = $('#toast');
    const toastMsgEl = $('#toastMsg');
    const loadingEl = $('#loadingMessage');
    const errorEl = $('#errorMessage');
    const loadingStatusEl = $('#loadingStatus');

    // Initialize state object with dynamic options
    const reviewOptions = {{ options | tojson }};
    const reviewType = '{{ review_type }}';
    const reviewAppend = {{ review_obj.append | tojson }};
    const state = {};
    reviewOptions.forEach(option => {
        state[option] = [];
    });

    function showToast(msg){toastMsgEl.textContent=msg;toastEl.hidden=false;clearTimeout(showToast.t);showToast.t=setTimeout(()=>toastEl.hidden=true,1200);}
    function getInitials(str){return str.slice(0,2).toUpperCase();}

    function buildCartItem(name,title){
      const item=document.createElement('div');
      item.className='cart-item';
      item.dataset.imagesetname=name;
      item.innerHTML=`<div class="thumb">${getInitials(title||name)}</div><div>${title||name}</div>`;
      return item;
    }

    function addToCart(card,cart){
      const name=card.dataset.imagesetname;const title=card.querySelector('.title')?.textContent.trim();
      if(state[cart].includes(name))return;
      state[cart].push(name);
      card.hidden=true;
      const item=buildCartItem(name,title);
      $("#"+cart+"Items").appendChild(item);
      updateCounts();
    }

    function copyList(cart){
      const text=state[cart].join('\n');
      if(!text){showToast('Empty '+cart);return;}
      navigator.clipboard.writeText(text).then(()=>showToast('Copied')).catch(()=>showToast('Fail'));
    }
    
    function clearCart(cart){
      state[cart].forEach(name=>{const orig=cardsEl.querySelector(`.review-card[data-imagesetname="${CSS.escape(name)}"]`);if(orig)orig.hidden=false;});
      state[cart]=[];$('#'+cart+'Items').innerHTML='';
      updateCounts();
    }

    async function applyCart(cart) {
      const imagesets = state[cart];
      if (!imagesets || imagesets.length === 0) {
        showToast('Empty ' + cart + ' cart');
        return;
      }

      try {
        // Get foldername from the page context
        const foldername = '{{ foldername }}';
        
        // Prepare the API payload
        const payload = {
          update_type: reviewType,
          value: cart,
          imagesets: imagesets,
          append: reviewAppend
        };

        // Make the API call
        const response = await fetch(`/api/folder/${foldername}/batch_update`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (response.ok) {
          // Success - clear the cart without restoring cards to review section
          // Only restore failed imagesets back to the review section
          if (result.failed_imagesets && result.failed_imagesets.length > 0) {
            result.failed_imagesets.forEach(name => {
              const orig = cardsEl.querySelector(`.review-card[data-imagesetname="${CSS.escape(name)}"]`);
              if (orig) orig.hidden = false;
            });
          }
          
          // Clear the cart state and DOM
          state[cart] = [];
          $('#' + cart + 'Items').innerHTML = '';
          updateCounts();
          
          const successMsg = result.failed_count > 0 
            ? `Applied ${result.successful_count}/${result.total_imagesets} (${result.failed_count} failed)`
            : `Applied ${result.successful_count} imagesets to ${cart}`;
          showToast(successMsg);
        } else {
          // Error response from API
          showToast(`Apply failed: ${result.error || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Apply cart error:', error);
        showToast('Apply failed: Network error');
      }
    }

    function updateCounts() {
      const total = $$('.review-card').length;
      const visible = $$('.review-card:not([hidden])').length;
      $('#totalCount').textContent = total;
      $('#visibleCount').textContent = visible;
    }

    // Function to open image in new tab
    function openImage(imagesetName, imagePath, foldername) {
      if (!imagePath) return;
      
      // Construct the full path using the image serving route
      const fullPath = `/images/${foldername}/${imagesetName}/${imagePath}`;
      window.open(fullPath, '_blank');
    }
    
    // Helper function to join Windows paths properly
    function joinWinPath(dir, name) {
      let p = dir.replace(/\//g, '\\');
      if (!p.endsWith('\\')) p += '\\';
      return p + name;
    }
    
    // Function to copy a Windows path
    function copyWindowsPath(btn) {
      const folderPath = btn.dataset.folder;
      // Use the folder path directly since it already contains the full path to the imageset
      const path = folderPath.replace(/\//g, '\\');
      navigator.clipboard.writeText(path).then(() => {
        showToast('Copied path');
      }).catch(err => {
        console.error('Failed to copy: ', err);
        showToast('Copy failed');
      });
    }

    // Event listeners
    $('.review-content').addEventListener('click',e=>{
      const card=e.target.closest('.review-card');
      if(!card)return;
      if(e.target.classList.contains('option-btn')){
        const option = e.target.dataset.option;
        addToCart(card, option);
      }
    });

    // Dynamic event listeners for copy, clear, and apply buttons
    reviewOptions.forEach(option => {
        const copyBtn = $('#copy' + option.charAt(0).toUpperCase() + option.slice(1) + 'Btn');
        const clearBtn = $('#clear' + option.charAt(0).toUpperCase() + option.slice(1) + 'Btn');
        const applyBtn = $('#apply' + option.charAt(0).toUpperCase() + option.slice(1) + 'Btn');
        
        if (copyBtn) copyBtn.onclick = () => copyList(option);
        if (clearBtn) clearBtn.onclick = () => clearCart(option);
        if (applyBtn) applyBtn.onclick = () => applyCart(option);
    });

    $('#year').textContent=new Date().getFullYear();

    // Initialize page when DOM loads
    document.addEventListener('DOMContentLoaded', function() {
      // Update counts for already rendered cards
      updateCounts();
      $('#loadingStatus').textContent = 'Loaded';
    });
</script>
{% endblock scripts %}
