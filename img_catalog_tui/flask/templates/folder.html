{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block page_title %}{{ title }}{% endblock %}


{% block content %}
{% if error %}
    <div class="error-message">
        {{ error }}
    </div>
{% else %}
    <div class="section">
        <h2 class="section-title">Folder Information</h2>
        <div class="folder-path" style="font-family: var(--font-mono); background: var(--muted); padding: var(--space-sm); border-radius: var(--radius-sm); margin-bottom: var(--space-md); word-break: break-all;">{{ folder_data.foldername }}</div>
                    
        <div class="grid grid-2" style="margin-top: var(--space-md);">
            <div class="card">
                <div class="card-content text-center">
                    <div style="font-size: 2rem; font-weight: bold; color: var(--accent);">{{ folder_data.imageset_count }}</div>
                    <div style="font-size: 0.875rem; color: var(--text); opacity: 0.8;">Total Imagesets</div>
                </div>
            </div>
        </div>
        
        {% if folder_data.counts.status %}
        <div class="grid grid-3" style="margin-top: var(--space-md);">
            {% for status, count in folder_data.counts.status.items() %}
            <div class="card">
                <div class="card-content text-center">
                    <div style="font-size: 2rem; font-weight: bold; color: var(--accent);">{{ count }}</div>
                    <div style="font-size: 0.875rem; color: var(--text); opacity: 0.8; margin-bottom: var(--space-sm);">{{ status or 'new' }}</div>
                    <button onclick="openMoveByStatusDialog('{{ status or 'new' }}')" class="btn btn-secondary" style="padding: var(--space-xs) var(--space-sm); font-size: 0.8rem;">
                        üì¶ Move
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <div style="margin-top: var(--space-lg); padding-top: var(--space-md); border-top: 1px solid var(--border);">
            <div style="display: flex; gap: var(--space-md); flex-wrap: wrap;">
                <a href="/review/{{ foldername }}/list" class="btn btn-primary">
                    üìã Review Presets
                </a>
                <a href="/folder/{{ foldername }}/batch_update" class="btn btn-primary">
                    üîÑ Batch Update Imagesets
                </a>
                <button onclick="openMoveAllDialog()" class="btn btn-primary">
                    üì¶ Move All Imagesets
                </button>
            </div>
        </div>
    </div>
                
    <div class="section">
        <h2 class="section-title">
            üìÅ Imagesets
        </h2>
        
        {% if folder_data.imagesets %}
            <div class="imagesets-grid">
                {% for imageset_name, imageset in folder_data.imagesets.items() %}
                    <a href="/imageset/{{ foldername }}/{{ imageset_name }}" style="text-decoration: none; color: inherit;">
                        <div class="card" style="cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease;" 
                             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" 
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                            <div class="card-header">
                                <h3 style="margin: 0; color: var(--accent); font-size: 1.1rem;">{{ imageset_name }}</h3>
                                <span class="status status-{{ imageset.status or 'new' }}">
                                    {{ imageset.status or 'new' }}
                                </span>
                            </div>
                                        
                            <div class="card-content">
                                <!-- Cover Image Section -->
                                {% if imageset.cover_image %}
                                <div style="text-align: center; margin-bottom: var(--space-md); padding-bottom: var(--space-md); border-bottom: 1px solid var(--border);">
                                    <img src="/images/{{ foldername }}/{{ imageset_name }}/{{ imageset.cover_image.split('/')[-1] }}" 
                                         alt="Cover image for {{ imageset_name }}" 
                                         style="max-width: 100%; max-height: 400px; width: auto; height: auto; border-radius: var(--radius-sm); border: 1px solid var(--border); object-fit: contain;">
                                </div>
                                {% else %}
                                <div style="text-align: center; margin-bottom: var(--space-md); padding: var(--space-lg); border-bottom: 1px solid var(--border);">
                                    <div style="color: var(--text); opacity: 0.4; font-size: 3rem;">üì∑</div>
                                    <div style="font-size: 0.875rem; color: var(--text); opacity: 0.6; margin-top: var(--space-xs);">No cover image</div>
                                </div>
                                {% endif %}
                                
                                <!-- Metadata Section -->
                                <div style="display: grid; gap: var(--space-sm);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-xs) 0; border-bottom: 1px solid var(--border);">
                                        <span style="font-size: 0.875rem; color: var(--text); opacity: 0.8;">Files</span>
                                        <span style="font-weight: 500; color: var(--accent);">{{ imageset.files|length }}</span>
                                    </div>
                                    
                                    {% if imageset.source %}
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-xs) 0; border-bottom: 1px solid var(--border);">
                                        <span style="font-size: 0.875rem; color: var(--text); opacity: 0.8;">Source</span>
                                        <span style="font-weight: 500; text-align: right; max-width: 60%; word-break: break-word;">{{ imageset.source }}</span>
                                    </div>
                                    {% endif %}
                                    
                                    {% if imageset.edits %}
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-xs) 0; border-bottom: 1px solid var(--border);">
                                        <span style="font-size: 0.875rem; color: var(--text); opacity: 0.8;">Edits</span>
                                        <span style="font-weight: 500; text-align: right; max-width: 60%; word-break: break-word;">{{ imageset.edits }}</span>
                                    </div>
                                    {% endif %}
                                    
                                    {% if imageset.needs %}
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-xs) 0; border-bottom: 1px solid var(--border);">
                                        <span style="font-size: 0.875rem; color: var(--text); opacity: 0.8;">Needs</span>
                                        <span style="font-weight: 500; text-align: right; max-width: 60%; word-break: break-word;">{{ imageset.needs }}</span>
                                    </div>
                                    {% endif %}
                                    
                                    {% if imageset.posted_to %}
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-xs) 0;">
                                        <span style="font-size: 0.875rem; color: var(--text); opacity: 0.8;">Posted To</span>
                                        <span style="font-weight: 500; text-align: right; max-width: 60%; word-break: break-word;">{{ imageset.posted_to }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="card-footer" style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.875rem; color: var(--text); opacity: 0.8;">Click to view details ‚Üí</span>
                                <a href="/imageset/{{ foldername }}/{{ imageset_name }}/move" 
                                   class="btn btn-primary" 
                                   style="padding: var(--space-xs) var(--space-sm); font-size: 0.8rem;" 
                                   target="_blank"
                                   onclick="event.stopPropagation();">
                                    üì¶ Move
                                </a>
                            </div>
                        </div>
                    </a>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center" style="padding: var(--space-2xl); color: var(--text); opacity: 0.6;">
                <p>No imagesets found in this folder.</p>
            </div>
        {% endif %}
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Get available folders for dropdown
const availableFolders = {{ folder_data | tojson if folder_data else '{}' }};

// Fetch all available folders from API
async function getAvailableFolders() {
    try {
        const response = await fetch('/api/folders');
        if (!response.ok) {
            throw new Error('Failed to fetch folders');
        }
        return await response.json();
    } catch (error) {
        console.error('Error fetching folders:', error);
        return {};
    }
}

// Open dialog for moving all imagesets
async function openMoveAllDialog() {
    const folders = await getAvailableFolders();
    const currentFolder = '{{ foldername }}';
    
    // Filter out current folder
    const targetFolders = Object.keys(folders).filter(f => f !== currentFolder);
    
    if (targetFolders.length === 0) {
        alert('No other folders available to move to.');
        return;
    }
    
    // Create options for select
    const options = targetFolders.map(f => `<option value="${f}">${f}</option>`).join('');
    
    // Create custom dialog
    const dialogHTML = `
        <div id="moveDialog" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
            <div style="background: var(--bg); padding: var(--space-lg); border-radius: var(--radius-md); max-width: 500px; width: 90%;">
                <h3 style="margin-top: 0; color: var(--accent);">üì¶ Move All Imagesets</h3>
                <p style="color: var(--text);">Select the destination folder for ALL imagesets in this folder.</p>
                <select id="targetFolderSelect" style="width: 100%; padding: var(--space-sm); border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); margin-bottom: var(--space-md);">
                    <option value="">Select folder...</option>
                    ${options}
                </select>
                <div style="display: flex; gap: var(--space-md); justify-content: flex-end;">
                    <button onclick="closeMoveDialog()" class="btn btn-secondary">Cancel</button>
                    <button onclick="executeMoveAll()" class="btn btn-primary">Move All</button>
                </div>
                <div id="moveStatus" style="margin-top: var(--space-md);"></div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', dialogHTML);
}

// Open dialog for moving imagesets by status
async function openMoveByStatusDialog(status) {
    const folders = await getAvailableFolders();
    const currentFolder = '{{ foldername }}';
    
    // Filter out current folder
    const targetFolders = Object.keys(folders).filter(f => f !== currentFolder);
    
    if (targetFolders.length === 0) {
        alert('No other folders available to move to.');
        return;
    }
    
    // Create options for select
    const options = targetFolders.map(f => `<option value="${f}">${f}</option>`).join('');
    
    // Create custom dialog
    const dialogHTML = `
        <div id="moveDialog" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
            <div style="background: var(--bg); padding: var(--space-lg); border-radius: var(--radius-md); max-width: 500px; width: 90%;">
                <h3 style="margin-top: 0; color: var(--accent);">üì¶ Move Imagesets by Status</h3>
                <p style="color: var(--text);">Move all imagesets with status "<strong>${status}</strong>" to the selected folder.</p>
                <select id="targetFolderSelect" style="width: 100%; padding: var(--space-sm); border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); margin-bottom: var(--space-md);">
                    <option value="">Select folder...</option>
                    ${options}
                </select>
                <div style="display: flex; gap: var(--space-md); justify-content: flex-end;">
                    <button onclick="closeMoveDialog()" class="btn btn-secondary">Cancel</button>
                    <button onclick="executeMoveByStatus('${status}')" class="btn btn-primary">Move</button>
                </div>
                <div id="moveStatus" style="margin-top: var(--space-md);"></div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', dialogHTML);
}

// Close move dialog
function closeMoveDialog() {
    const dialog = document.getElementById('moveDialog');
    if (dialog) {
        dialog.remove();
    }
}

// Execute move all operation
async function executeMoveAll() {
    const targetFolder = document.getElementById('targetFolderSelect').value;
    const statusDiv = document.getElementById('moveStatus');
    
    if (!targetFolder) {
        statusDiv.innerHTML = '<div class="error-message">Please select a target folder.</div>';
        return;
    }
    
    if (!confirm(`Are you sure you want to move ALL imagesets to "${targetFolder}"?`)) {
        return;
    }
    
    statusDiv.innerHTML = '<div style="color: var(--text);">‚è≥ Moving imagesets...</div>';
    
    try {
        const response = await fetch('/api/folder/{{ foldername }}/move_imagesets', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                target_foldername: targetFolder
            })
        });
        
        const data = await response.json();
        
        if (response.ok || response.status === 207) {
            statusDiv.innerHTML = `<div style="color: var(--accent);">‚úÖ Moved ${data.successful_count} imageset(s) successfully!</div>`;
            if (data.failed_count > 0) {
                statusDiv.innerHTML += `<div style="color: var(--text); opacity: 0.8; margin-top: var(--space-xs);">‚ö†Ô∏è ${data.failed_count} failed</div>`;
            }
            
            // Refresh page after short delay
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            statusDiv.innerHTML = `<div class="error-message">‚ùå Error: ${data.error || 'Failed to move imagesets'}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="error-message">‚ùå Error: ${error.message}</div>`;
    }
}

// Execute move by status operation
async function executeMoveByStatus(status) {
    const targetFolder = document.getElementById('targetFolderSelect').value;
    const statusDiv = document.getElementById('moveStatus');
    
    if (!targetFolder) {
        statusDiv.innerHTML = '<div class="error-message">Please select a target folder.</div>';
        return;
    }
    
    if (!confirm(`Are you sure you want to move all imagesets with status "${status}" to "${targetFolder}"?`)) {
        return;
    }
    
    statusDiv.innerHTML = '<div style="color: var(--text);">‚è≥ Moving imagesets...</div>';
    
    try {
        const response = await fetch('/api/folder/{{ foldername }}/move_imagesets', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                target_foldername: targetFolder,
                filter_status: status
            })
        });
        
        const data = await response.json();
        
        if (response.ok || response.status === 207) {
            statusDiv.innerHTML = `<div style="color: var(--accent);">‚úÖ Moved ${data.successful_count} imageset(s) successfully!</div>`;
            if (data.failed_count > 0) {
                statusDiv.innerHTML += `<div style="color: var(--text); opacity: 0.8; margin-top: var(--space-xs);">‚ö†Ô∏è ${data.failed_count} failed</div>`;
            }
            
            // Refresh page after short delay
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            statusDiv.innerHTML = `<div class="error-message">‚ùå Error: ${data.error || 'Failed to move imagesets'}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="error-message">‚ùå Error: ${error.message}</div>`;
    }
}

// Close dialog on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeMoveDialog();
    }
});
</script>
{% endblock %}
